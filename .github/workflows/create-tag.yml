name: Tag and start release
on:
  workflow_dispatch:
env:
  DART_VERSION: 3.1.0
jobs:
  create-tag:
    name: Create tags for release
    permissions:
      actions: write # Required to trigger publish.yml workflow
      contents: write # Required to create and push git tags
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: ${{ env.DART_VERSION }}
      - name: Setup Melos
        run: |
          dart pub global activate melos
          dart pub global run melos bootstrap
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - name: Create tags
        run: |
          # Create tags for all packages (including if they already exist)
          # We don't care about errors due to creating new tags (`|| true`)
          melos exec -c 1 --no-private -- git tag \$MELOS_PACKAGE_NAME-v\$MELOS_PACKAGE_VERSION || true
          git push --tags
      - name: Start release
        run: |
          # Trigger publish workflow for packages that haven't been published yet
          melos exec -c 1 --no-published --no-private --order-dependents -- \
          gh workflow run publish.yml \
          --ref \$MELOS_PACKAGE_NAME-v\$MELOS_PACKAGE_VERSION
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
